#!/usr/bin/env python
# -*- encoding: utf8 -*-

import re
import subprocess
import sys
import optparse
import os


__author__ = 'fcamel'


def check_install():
    for cmd in ['mkid', 'gid']:
        ret = os.system('which %s > /dev/null' % cmd)
        if ret != 0:
            msg = (
                "The program '%s' is currently not installed.  "
                "You can install it by typing:\n"
                "sudo apt-get install id-utils" % cmd
            )
            print msg
            sys.exit(1)


def gid(pattern):
    cmd = ['gid', pattern]
    process = subprocess.Popen(cmd,
                               stdout=subprocess.PIPE,
                               stderr=subprocess.PIPE)
    return process.stdout.read().split('\n')

def show_list(tokens_list, patterns, last_n):
    def yellow(text):
        return '\033[1;33m%s\033[0m' % text

    def yellow_background(text):
        return '\033[30;43m%s\033[0m' % text

    def green(text):
        return '\033[1;32m%s\033[0m' % text

    def red(text):
        return '\033[1;31m%s\033[0m' % text

    def black(text):
        return '\033[1;30m%s\033[0m' % text

    os.system('clear')
    for i, (filename, line_number, code) in enumerate(tokens_list):
        i += 1
        if i == last_n:
            print black('(%s) %s:%s:%s' % (i, line_number, filename, code))
        else:
            for pattern in patterns:
                code = code.replace(pattern, yellow_background(pattern))
            print '(%s) %s:%s:%s' % (red(i), yellow(line_number), green(filename), code)

def diff_list(kept, removed):
    return [e for e in kept if e not in removed]

def filter_statement(tokens_list, exclude):
    matched = [tokens for tokens in tokens_list if re.search(';\s*$', tokens[2])]
    if not exclude:
        return matched
    return diff_list(tokens_list, matched)

def filter_filename(tokens_list, pattern, exclude):
    matched = [tokens for tokens in tokens_list if re.search(pattern, tokens[0])]
    if not exclude:
        return matched
    return diff_list(tokens_list, matched)

def filter_pattern(tokens_list, pattern):
    return [tokens for tokens in tokens_list if re.search('\\b%s\\b' % pattern, tokens[2])]

def filter_until_select(tokens_list, patterns, last_n):
    '''
    Return:
        >0: selected number.
         0: normal exit.
        <0: error.
    '''
    tokens_list = tokens_list[:]  # Make a clone.

    # Enter interactive mode.
    while True:
        if not tokens_list:
            print 'No file matched.'
            return 0, tokens_list

        show_list(tokens_list, patterns, last_n)
        msg = (
            '\nSelect an action:'
            '\n* Input number to select a file.'
            '\n* Type ";" / "!;" to keep / remove statements.'
            '\n* Type STRING (regex) to filter filename. !STRING means exclude the matched filename: '
            '\n* Type ENTER to exit.'
            '\n'
            '\n>> '
        )
        response = raw_input(msg).strip()
        if not response:
            return 0, tokens_list

        if re.match('\d+', response):
            break

        # Clean/Keep statements
        if response in [';', '!;']:
            tokens_list = filter_statement(tokens_list, response == '!;')
            continue

        # Clean/Keep based on filename
        if response[0] == '!':
            exclude = True
            response = response[1:]
        else:
            exclude = False
        tokens_list = filter_filename(tokens_list, response, exclude)

    # Parse the selected number
    try:
        n = int(response)
    except ValueError, e:
        print 'Invalid input.'
        return -1, tokens_list

    if n < 1 or n > len(tokens_list):
        print 'Invalid input.'
        return -1, tokens_list

    return n, tokens_list

def main():
    '''\
    %prog [options] <pattern> [<pattern> ...]

    Grep pattern in source codes using id-utils.
    Before starting, type 'mkid' in your source root first.

    Example of usages:
        $ gj MyClient         # find any snippet which contains MyClient
        $ gj MyClient class   # find the definition.
    '''
    check_install()

    parser = optparse.OptionParser(usage=main.__doc__)
    options, args = parser.parse_args()

    if len(args) < 1:
        parser.print_help()
        sys.exit(1)

    if not os.path.exists('ID'):
        print 'Database file "ID" is not found. Have you run "mkid"?'
        return 2

    # Find the initial matched set.
    patterns = args
    first_pattern = patterns[0]

    lines = gid(first_pattern)
    tokens_list = [line.split(':', 2) for line in lines]
    tokens_list = [ts for ts in tokens_list if len(ts) == 3]

    for pattern in patterns[1:]:
        tokens_list = filter_pattern(tokens_list, pattern)

    # Filter the rest or view the selected file.
    n = 0
    while True:
        n, tokens_list = filter_until_select(tokens_list, patterns, n)
        if n <= 0:
            if n < 0:
                return 1
            return 0

        # Edit the chosen one.
        filename, line, _ = tokens_list[n - 1]

        cmd = 'vi %s +%s -c/%s' % (filename, line, first_pattern)
        ret = os.system(cmd)
        if ret != 0:
            return 2

    return 0


if __name__ == '__main__':
    sys.exit(main())
